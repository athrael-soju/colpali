# ColQwen3 Training Configuration - Optimized for RTX 5090 32GB
#
# This config is tuned for single-GPU training on RTX 5090 with 32GB VRAM
# Using Qwen3-VL-2B-Instruct backbone for comfortable memory headroom
#
# Usage:
#   USE_LOCAL_DATASET=0 python scripts/train/train_colbert.py scripts/configs/qwen3/train_colqwen3_rtx5090.yaml
#
# NOTE: USE_LOCAL_DATASET=0 loads data from HuggingFace (vidore/colpali_train_set)
#
# Post-training evaluation with ViDoRe V3:
#   pip install vidore-benchmark
#   vidore-benchmark evaluate --model-name ./models/colqwen3-rtx5090 --collection vidore_v3

config:
  (): colpali_engine.trainer.colmodel_training.ColModelTrainingConfig
  output_dir: !path ../../../models/colqwen3-rtx5090

  # Processor configuration
  processor:
    (): colpali_engine.utils.transformers_wrappers.AllPurposeWrapper
    class_to_instanciate: !ext colpali_engine.models.ColQwen3Processor
    pretrained_model_name_or_path: "Qwen/Qwen3-VL-2B-Instruct"
    max_num_visual_tokens: 768  # Reduced to allow larger batch size for more in-batch negatives

  # Model configuration
  model:
    (): colpali_engine.utils.transformers_wrappers.AllPurposeWrapper
    class_to_instanciate: !ext colpali_engine.models.ColQwen3
    pretrained_model_name_or_path: "Qwen/Qwen3-VL-2B-Instruct"
    torch_dtype: !ext torch.bfloat16
    use_cache: false
    attn_implementation: "flash_attention_2"
    trust_remote_code: true
    dim: 128

  # Dataset configuration
  train_dataset:
    (): colpali_engine.utils.dataset_transformation.load_train_set
  # Evaluation disabled during training - run vidore-benchmark post-training
  # eval_dataset: !import ../data/test_data_hf.yaml

  run_eval: false
  run_train: true

  # Loss function
  loss_func:
    (): colpali_engine.loss.late_interaction_losses.ColbertPairwiseCELoss

  # Training arguments - Optimized for RTX 5090 32GB
  tr_args:
    (): transformers.training_args.TrainingArguments
    output_dir: null
    overwrite_output_dir: true

    # === BATCH SIZE SETTINGS ===
    # CRITICAL: Contrastive learning needs large batch for in-batch negatives
    # With reduced visual tokens (768), we can fit larger batches
    per_device_train_batch_size: 32  # 31 in-batch negatives per sample
    gradient_accumulation_steps: 2   # Effective batch size: 64

    # Memory optimization - CRITICAL for fitting in VRAM
    gradient_checkpointing: true
    gradient_checkpointing_kwargs: { "use_reentrant": false }

    # Precision - RTX 5090 has excellent bf16 support
    bf16: true
    bf16_full_eval: true

    # Evaluation disabled - run vidore-benchmark after training
    eval_strategy: "no"

    # Training schedule
    num_train_epochs: 5
    warmup_steps: 200

    # Optimizer settings
    learning_rate: 5e-4  # Higher LR for better gradient signal
    weight_decay: 0.01
    lr_scheduler_type: "cosine"
    # optim: "adamw_torch_fused"  # Faster on RTX 5090

    # Data loading - RTX 5090 pairs well with fast NVMe
    dataloader_num_workers: 8
    dataloader_pin_memory: true
    dataloader_prefetch_factor: 2

    # Checkpointing
    save_steps: 500
    save_total_limit: 3
    logging_steps: 10

    # Logging
    report_to: "wandb"
    # run_name: "colqwen3-rtx5090-2b"

  # PEFT/LoRA - Reduces trainable params, saves memory
  peft_config:
    (): peft.LoraConfig
    r: 32
    lora_alpha: 32
    lora_dropout: 0.1
    init_lora_weights: "gaussian"
    bias: "none"
    task_type: "FEATURE_EXTRACTION"
    target_modules: '(.*(model).*(down_proj|gate_proj|up_proj|k_proj|q_proj|v_proj|o_proj).*$|.*(custom_text_proj).*$)'
