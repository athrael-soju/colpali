# ColQwen3 Training Configuration
# Based on Qwen3-VL backbone with ColBERT-style late interaction
#
# Usage:
#   python scripts/train/train_colbert.py scripts/configs/qwen3/train_colqwen3_model.yaml
#
# For distributed training:
#   torchrun --nproc_per_node=8 scripts/train/train_colbert.py scripts/configs/qwen3/train_colqwen3_model.yaml

config:
  (): colpali_engine.trainer.colmodel_training.ColModelTrainingConfig
  output_dir: !path ../../../models/colqwen3-trained

  # Processor configuration
  processor:
    (): colpali_engine.utils.transformers_wrappers.AllPurposeWrapper
    class_to_instanciate: !ext colpali_engine.models.ColQwen3Processor
    pretrained_model_name_or_path: "Qwen/Qwen3-VL-2B-Instruct"  # Or Qwen3-VL-8B-Instruct for larger model
    max_num_visual_tokens: 1280  # Recommended by TomoroAI for ColQwen3

  # Model configuration
  model:
    (): colpali_engine.utils.transformers_wrappers.AllPurposeWrapper
    class_to_instanciate: !ext colpali_engine.models.ColQwen3
    pretrained_model_name_or_path: "Qwen/Qwen3-VL-2B-Instruct"  # Or Qwen3-VL-8B-Instruct for larger model
    torch_dtype: !ext torch.bfloat16
    use_cache: false
    attn_implementation: "flash_attention_2"
    trust_remote_code: true
    dim: 128  # Embedding dimension (128 is standard for ColPali models)

  # Dataset configuration
  train_dataset:
    (): colpali_engine.utils.dataset_transformation.load_train_set
  eval_dataset: !import ../data/test_data.yaml

  # Training settings
  run_eval: true
  run_train: true

  # Loss function - ColBERT pairwise cross-entropy loss
  loss_func:
    (): colpali_engine.loss.late_interaction_losses.ColbertPairwiseCELoss

  # Training arguments
  tr_args:
    (): transformers.training_args.TrainingArguments
    output_dir: null
    overwrite_output_dir: true

    # Training epochs and batch size
    num_train_epochs: 5
    per_device_train_batch_size: 32  # Adjust based on GPU memory (4B model needs more memory)
    gradient_accumulation_steps: 2   # Effective batch size = 32 * 2 = 64
    gradient_checkpointing: true
    gradient_checkpointing_kwargs: { "use_reentrant": false }

    # Evaluation settings
    per_device_eval_batch_size: 4
    eval_strategy: "steps"
    eval_steps: 100

    # Data loading
    dataloader_num_workers: 8

    # Precision
    bf16: true

    # Checkpointing
    save_steps: 500
    save_total_limit: 2

    # Logging
    logging_steps: 10
    report_to: "wandb"
    # run_name: "colqwen3-training"

    # Optimization
    learning_rate: 1e-4  # Lower LR for larger model
    warmup_steps: 200
    weight_decay: 0.01
    lr_scheduler_type: "cosine"

    # Memory optimization
    # optim: "paged_adamw_8bit"  # Uncomment for memory-constrained setups

  # PEFT/LoRA configuration for parameter-efficient fine-tuning
  peft_config:
    (): peft.LoraConfig
    r: 32
    lora_alpha: 32
    lora_dropout: 0.1
    init_lora_weights: "gaussian"
    bias: "none"
    task_type: "FEATURE_EXTRACTION"
    # Target all attention projections and the custom projection layer
    target_modules: '(.*(model).*(down_proj|gate_proj|up_proj|k_proj|q_proj|v_proj|o_proj).*$|.*(custom_text_proj).*$)'
